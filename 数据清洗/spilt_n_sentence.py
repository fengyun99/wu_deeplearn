#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time     : 2023/8/15 16:23
# @Author   : FengYun
# @File     : spilt_n_sentence.py
# @Software : PyCharm
str01 = r'\n\n中华人民共和国财政部 国家档案局令第79号\n《会计档案管理办法》已经财政部部务会议、国家档案局局务会议修订通过，现将修订后的《会计档案管理办法》公布，自2016年1月1日起施行。\n中华人民共和国财政部部长 楼继伟\n国家档案局局长 李明华 \n2015年12月11日\n\n会计档案管理办法\n第一条 为了加强会计档案管理，有效保护和利用会计档案，根据《中华人民共和国会计法》《中华人民共和国档案法》等有关法律和行政法规，制定本办法。\n第二条 国家机关、社会团体、企业、事业单位和其他组织（以下统称单位）档案适用本办法。\n第三条 本办法所称会计档案是指单位在进行会计核算等过程中接收或形成的，记录和反映单位经济业务事项的，具有保存价值的文字、图表等各种形式的会计资料，包括通过计算机等电子设备形成、传输和存储的电子会计档案。\n第四条 财政部和国家档案局主管全国会计档案工作，共同制定全国统一的会计档案工作制度，对全国会计档案工作实行监督和指导。\n县级以上地方人民政府财政部门和档案行政管理部门管理本行政区域内的会计档案工作，并对本行政区域内会计档案工作实行监督和指导。\n第五条 单位应当加强会计档案管理工作，建立和完善会计档案的收集、整理、保管、利用和鉴定销毁等管理制度，采取可靠的安全防护技术和措施，保证会计档案的真实、完整、可用、安全。\n单位的档案机构或者档案工作人员所属机构（以下统称单位档案管理机构）负责管理本单位的会计档案。单位也可以委托具备档案管理条件的机构代为管理会计档案。\n第六条 下列会计资料应当进行归档：\n（一）会计凭证，包括原始凭证、记账凭证；\n（二）会计账簿，包括总账、明细账、日记账、固定资产卡片及其他辅助性账簿；\n（三）财务会计报告，包括月度、季度、半年度、年度财务会计报告；\n（四）其他会计资料，包括、银行对账单、纳税申报表、会计档案移交清册、会计档案保管清册、会计档案销毁清册、会计档案鉴定意见书及其他具有保存价值的会计资料。\n第七条 单位可以利用计算机、网络通信等信息技术手段管理会计档案。\n第八条 同时满足下列条件的，单位内部形成的属于归档范围的电子会计资料可仅以电子形式保存，形成电子会计档案：\n（一）形成的电子会计资料来源真实有效，由计算机等电子设备形成和传输；\n（二）使用的会计核算系统能够准确、完整、有效接收和读取电子会计资料，能够输出符合国家标准归档格式的会计凭证、会计账簿、财务会计报表等会计资料，设定了经办、审核、审批等必要的审签程序；\n（三）使用的电子档案管理系统能够有效接收、管理、利用电子会计档案，符合电子档案的长期保管要求，并建立了电子会计档案与相关联的其他纸质会计档案的检索关系；\n（四）采取有效措施，防止电子会计档案被篡改；\n（五）建立电子会计档案备份制度，能够有效防范自然灾害、意外事故和人为破坏的影响；\n（六）形成的电子会计资料不属于具有永久保存价值或者其他重要保存价值的会计档案。\n第九条 满足本办法第八条规定条件，单位从外部接收的电子会计资料附有符合《中华人民共和国电子签名法》规定的电子签名的，可仅以电子形式归档保存，形成电子会计档案。\n第十条 单位的会计机构或会计人员所属机构（以下统称单位会计管理机构）按照归档范围和归档要求，负责定期将应当归档的会计资料整理立卷，编制会计档案保管清册。\n第十一条 当年形成的会计档案，在会计年度终了后，可由单位会计管理机构临时保管一年，再移交单位档案管理机构保管。因工作需要确需推迟移交的，应当经单位档案管理机构同意。\n单位会计管理机构临时保管会计档案最长不超过三年。临时保管期间，会计档案的保管应当符合国家档案管理的有关规定，且出纳人员不得兼管会计档案。\n第十二条 单位会计管理机构在办理会计档案移交时，应当编制会计档案移交清册，并按照国家档案管理的有关规定办理移交手续。\n纸质会计档案移交时应当保持原卷的封装。电子会计档案移交时应当将电子会计档案及其元数据一并移交，且文件格式应当符合国家档案管理的有关规定。特殊格式的电子会计档案应当与其读取平台一并移交。\n单位档案管理机构接收电子会计档案时，应当对电子会计档案的准确性、完整性、可用性、安全性进行检测，符合要求的才能接收。\n第十三条 单位应当严格按照相关制度利用会计档案，在进行会计档案查阅、复制、借出时履行登记手续，严禁篡改和损坏。\n单位保存的会计档案一般不得对外借出。确因工作需要且根据国家有关规定必须借出的，应当严格按照规定办理相关手续。\n会计档案借用单位应当妥善保管和利用借入的会计档案，确保借入会计档案的安全完整，并在规定时间内归还。\n第十四条 会计档案的保管期限分为永久、定期两类。定期保管期限一般分为10年和30年。\n会计档案的保管期限，从会计年度终了后的第一天算起。\n第十五条 各类会计档案的保管期限原则上应当按照本办法附表执行，本办法规定的为最低保管期限。\n单位会计档案的具体名称如有同本办法附表所列档案名称不相符的，应当比照类似档案的保管期限办理。\n第十六条 单位应当定期对已到保管期限的会计档案进行鉴定，并形成会计档案鉴定意见书。经鉴定，仍需继续保存的会计档案，应当重新划定保管期限；对保管期满，确无保存价值的会计档案，可以销毁。\n第十七条 会计档案鉴定工作应当由单位档案管理机构牵头，组织单位会计、审计、纪检监察等机构或人员共同进行。\n第十八条 经鉴定可以销毁的会计档案，应当按照以下程序销毁：\n（一）单位档案管理机构编制会计档案销毁清册，列明拟销毁会计档案的名称、卷号、册数、起止年度、档案编号、应保管期限、已保管期限和销毁时间等内容。\n（二）单位负责人、档案管理机构负责人、会计管理机构负责人、档案管理机构经办人、会计管理机构经办人在会计档案销毁清册上签署意见。\n（三）单位档案管理机构负责组织会计档案销毁工作，并与会计管理机构共同派员监销。监销人在会计档案销毁前，应当按照会计档案销毁清册所列内容进行清点核对；在会计档案销毁后，应当在会计档案销毁清册上签名或盖章。\n电子会计档案的销毁还应当符合国家有关电子档案的规定，并由单位档案管理机构、会计管理机构和信息系统管理机构共同派员监销。\n第十九条 保管期满但未结清的债权债务会计凭证和涉及其他未了事项的会计凭证不得销毁，纸质会计档案应当单独抽出立卷，电子会计档案单独转存，保管到未了事项完结时为止。\n单独抽出立卷或转存的会计档案，应当在会计档案鉴定意见书、会计档案销毁清册和会计档案保管清册中列明。\n第二十条 单位因撤销、解散、破产或其他原因而终止的，在终止或办理注销登记手续之前形成的会计档案，按照国家档案管理的有关规定处置。\n第二十一条 单位分立后原单位存续的，其会计档案应当由分立后的存续方统一保管，其他方可以查阅、复制与其业务相关的会计档案。\n单位分立后原单位解散的，其会计档案应当经各方协商后由其中一方代管或按照国家档案管理的有关规定处置，各方可以查阅、复制与其业务相关的会计档案。\n单位分立中未结清的会计事项所涉及的会计凭证，应当单独抽出由业务相关方保存，并按照规定办理交接手续。\n单位因业务移交其他单位办理所涉及的会计档案，应当由原单位保管，承接业务单位可以查阅、复制与其业务相关的会计档案。对其中未结清的会计事项所涉及的会计凭证，应当单独抽出由承接业务单位保存，并按照规定办理交接手续。\n第二十二条 单位合并后原各单位解散或者一方存续其他方解散的，原各单位的会计档案应当由合并后的单位统一保管。单位合并后原各单位仍存续的，其会计档案仍应当由原各单位保管。\n第二十三条 建设单位在项目建设期间形成的会计档案，需要移交给建设项目接受单位的，应当在办理竣工财务决算后及时移交，并按照规定办理交接手续。\n第二十四条 单位之间交接会计档案时，交接双方应当办理会计档案交接手续。\n移交会计档案的单位，应当编制会计档案移交清册，列明应当移交的会计档案名称、卷号、册数、起止年度、档案编号、应保管期限和已保管期限等内容。\n交接会计档案时，交接双方应当按照会计档案移交清册所列内容逐项交接，并由交接双方的单位有关负责人负责监督。交接完毕后，交接双方经办人和监督人应当在会计档案移交清册上签名或盖章。\n电子会计档案应当与其元数据一并移交，特殊格式的电子会计档案应当与其读取平台一并移交。档案接受单位应当对保存电子会计档案的载体及其技术环境进行检验，确保所接收电子会计档案的准确、完整、可用和安全。\n第二十五条 单位的会计档案及其复制件需要携带、寄运或者传输至境外的，应当按照国家有关规定执行。\n第二十六条 单位委托中介机构代理记账的，应当在签订的书面委托合同中，明确会计档案的管理要求及相应责任。\n第二十七条 违反本办法规定的单位和个人，由县级以上人民政府财政部门、档案行政管理部门依据《中华人民共和国会计法》《中华人民共和国档案法》等法律法规处理处罚。\n第二十八条 预算、计划、制度等文件材料，应当执行文书档案管理规定，不适用本办法。\n第二十九条 不具备设立档案机构或配备档案工作人员条件的单位和依法建账的个体工商户，其会计档案的收集、整理、保管、利用和鉴定销毁等参照本办法执行。\n第三十条 各省、自治区、直辖市、计划单列市人民政府财政部门、档案行政管理部门，新疆生产建设兵团财务局、档案局，国务院各业务主管部门，中国人民解放军总后勤部，可以根据本办法制定具体实施办法。\n第三十一条 本办法由财政部、国家档案局负责解释，自2016年1月1日起施行。1998年8月21日财政部、国家档案局发布的《》（财会字[1998]32号）同时废止。\n附表：\n1.企业和其他组织会计档案保管期限表\n2.财政总预算、行政单位、事业单位和税收会计档案保管期限表\n\n\n\n\n附表1\n\n企业和其他组织会计档案保管期限表\n\n\n\n附表2\n\n   财政总预算、行政单位、事业单位和税收会计档案保管期限表\n\n注：税务机关的税务经费会计档案保管期限，按行政单位会计档案保管期限规定办理。\n\n\n\n\n'
MAX_LENGTH = 512
list_out = [data.replace('\\n', '') for data in str01.split('。\\n') if data.replace('\\n', '') != '']
dict_save = {}
index = 1
for text in list_out:
    dict_save[index] = text + '。'
    index += 1


def split_text_by_sentence(text, max_length):
    """
    将文本按照句子分割，并在拼接句子时避免超过指定的最大长度，并在分割后的文本段末尾加上句号，
    除了最后一个分割后的文本段，最后一个分割后的文本段不加句号。

    参数:
    text (str): 需要分割的文本
    max_length (int): 每个分割后的字段的最大长度

    返回:
    List[str]: 分割后的文本段列表
    """
    # 用于存储分割后的文本段的列表
    segmented_text = []

    # 分割句子
    sentences = text.split("。")

    # 用于临时存储当前段落
    current_segment = ""

    for i, sentence in enumerate(sentences):
        # 尝试将句子拼接到当前段落
        if len(current_segment) + len(sentence) + 1 <= max_length:  # +1 用于考虑句号的长度
            if current_segment:
                current_segment += "。\n"  # 拼接句号
            current_segment += sentence.strip('\n')
        else:
            if current_segment:
                segmented_text.append(current_segment + "。\n")  # 在段落末尾添加句号
            current_segment = sentence.strip('\n')
    # 处理最后一个段落
    if current_segment:
        if i == len(sentences) - 1:
            segmented_text.append(current_segment)  # 不添加句号
        else:
            segmented_text.append(current_segment + "。\n")  # 在段落末尾添加句号

    return segmented_text


# 输出向前一段总结归纳，向后3段总结归纳，存入数据库就保存index
def get_context(dict_save: dict, index, backward_index, forward_index):
    max_length = len(dict_save)
    if not 0 < index < max_length + 1:
        raise IndexError(f'out of index, max index is {max_length}')

    if index == 1:
        length = 0
        all_data = ''
        for i in range(1, index + forward_index + 1):
            length += len(dict_save[i])
            all_data += dict_save[i] + '\n'
        if length < MAX_LENGTH:
            return [all_data]
        else:
            return split_text_by_sentence(all_data, MAX_LENGTH)

    if index == max_length:
        length = 0
        all_data = ''
        for i in range(index-backward_index, index + 1):
            length += len(dict_save[i])
            all_data += dict_save[i] + '\n'
        if length < MAX_LENGTH:
            return [all_data]
        else:
            return split_text_by_sentence(all_data, MAX_LENGTH)

    length = 0
    all_data = ''
    for i in range(index - backward_index, index + forward_index + 1):
        length += len(dict_save[i])
        all_data += dict_save[i] + '\n'

    if length < MAX_LENGTH:
        return [all_data]
    else:
        return split_text_by_sentence(all_data, MAX_LENGTH)


def loop_summary(text):
    prompt = f'''
    作为一个自然语言处理AI，对下列已知信息进行归纳总结。已知信息如下:
    {text}
    '''


# print(len(dict_save[1]) + len(dict_save[2]) + len(dict_save[2]) + len(dict_save[3]) + len(dict_save[4]))
# print(dict_save[3])
if __name__ == '__main__':
    print(get_context(dict_save,10,1,3))
